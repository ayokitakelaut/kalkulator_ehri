name: Build EHRI APK (Docker Stable)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Create main.py
        run: |
          cat << 'EOF' > main.py
          from kivy.app import App
          from kivy.uix.boxlayout import BoxLayout
          from kivy.uix.textinput import TextInput
          from kivy.uix.button import Button
          from kivy.uix.label import Label

          class EHRIApp(App):
              def build(self):
                  layout = BoxLayout(orientation="vertical", padding=10, spacing=10)

                  labels = [
                      "Sanitasi (%)",
                      "Air Bersih (%)",
                      "Kepadatan Penduduk",
                      "Kasus Diare (%)",
                      "Kemiskinan (%)"
                  ]

                  self.inputs = []

                  for text in labels:
                      layout.add_widget(Label(text=text))
                      inp = TextInput(multiline=False, input_filter="float")
                      layout.add_widget(inp)
                      self.inputs.append(inp)

                  btn = Button(text="Hitung EHRI")
                  btn.bind(on_press=self.calculate)
                  layout.add_widget(btn)

                  self.result = Label(text="Hasil:")
                  layout.add_widget(self.result)

                  return layout

              def calculate(self, instance):
                  try:
                      values = [float(i.text) for i in self.inputs]
                      weights = [0.30, 0.25, 0.15, 0.20, 0.10]
                      ehri = sum(v*w for v,w in zip(values, weights))

                      if ehri <= 33:
                          kategori = "Risiko Rendah"
                      elif ehri <= 66:
                          kategori = "Risiko Sedang"
                      else:
                          kategori = "Risiko Tinggi"

                      self.result.text = f"EHRI: {ehri:.2f} | {kategori}"
                  except:
                      self.result.text = "Input tidak valid"

          if __name__ == "__main__":
              EHRIApp().run()
          EOF

      - name: Create buildozer.spec
        run: |
          cat << 'EOF' > buildozer.spec
          [app]
          title = EHRI Calculator
          package.name = ehricalculator
          package.domain = org.ehri
          source.dir = .
          source.include_exts = py
          version = 1.0
          requirements = python3,kivy
          orientation = portrait

          [buildozer]
          log_level = 2
          warn_on_root = 1
          EOF

      - name: Build APK using Official Kivy Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/home/user/hostcwd \
            kivy/buildozer \
            buildozer android debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: EHRI-APK
          path: bin/*.apk
