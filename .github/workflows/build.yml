name: Build EHRI APK

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-pip git zip unzip openjdk-17-jdk wget
          pip install --upgrade pip
          pip install buildozer cython

      - name: Create main.py
        run: |
          cat << 'EOF' > main.py
          from kivy.app import App
          from kivy.uix.boxlayout import BoxLayout
          from kivy.uix.textinput import TextInput
          from kivy.uix.button import Button
          from kivy.uix.label import Label

          class EHRIApp(App):
              def build(self):
                  layout = BoxLayout(orientation="vertical", padding=10, spacing=10)

                  labels = [
                      "Sanitasi (%)",
                      "Air Bersih (%)",
                      "Kepadatan Penduduk",
                      "Kasus Diare (%)",
                      "Kemiskinan (%)"
                  ]

                  self.inputs = []

                  for text in labels:
                      layout.add_widget(Label(text=text))
                      inp = TextInput(multiline=False, input_filter="float")
                      layout.add_widget(inp)
                      self.inputs.append(inp)

                  btn = Button(text="Hitung EHRI")
                  btn.bind(on_press=self.calculate)
                  layout.add_widget(btn)

                  self.result = Label(text="Hasil:")
                  layout.add_widget(self.result)

                  return layout

              def calculate(self, instance):
                  try:
                      values = [float(i.text) for i in self.inputs]
                      weights = [0.30, 0.25, 0.15, 0.20, 0.10]
                      ehri = sum(v*w for v,w in zip(values, weights))

                      if ehri <= 33:
                          kategori = "Risiko Rendah"
                      elif ehri <= 66:
                          kategori = "Risiko Sedang"
                      else:
                          kategori = "Risiko Tinggi"

                      self.result.text = f"EHRI: {ehri:.2f} | {kategori}"
                  except:
                      self.result.text = "Input tidak valid"

          if __name__ == "__main__":
              EHRIApp().run()
          EOF

      - name: Setup Android SDK
        run: |
          mkdir -p $HOME/android-sdk
          cd $HOME/android-sdk
          wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O sdk.zip
          unzip sdk.zip

          mv cmdline-tools cmdline-tools-temp
          mkdir cmdline-tools
          mv cmdline-tools-temp cmdline-tools/latest

          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
          echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH

      - name: Accept Licenses & Install SDK
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.2"

      - name: Initialize Buildozer
        run: |
          buildozer init
          sed -i 's/title = .*/title = EHRI Calculator/' buildozer.spec
          sed -i 's/package.name = .*/package.name = ehricalculator/' buildozer.spec
          sed -i 's/package.domain = .*/package.domain = org.ehri/' buildozer.spec
          sed -i 's/requirements = .*/requirements = python3,kivy/' buildozer.spec
          sed -i 's/orientation = .*/orientation = portrait/' buildozer.spec

      - name: Build APK
        run: |
          buildozer android debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: EHRI-APK
          path: bin/*.apk
