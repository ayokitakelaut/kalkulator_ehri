name: Build EHRI APK
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Create EHRI App Files
        run: |
          python - <<EOF
          # =========================
          # FILE 1: main.py
          # =========================
          main_code = """
from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.uix.label import Label

class EHRIApp(App):
    def build(self):
        self.layout = BoxLayout(orientation='vertical', padding=10, spacing=10)

        self.inputs = []
        labels = [
            "Sanitasi (%)",
            "Air Bersih (%)",
            "Kepadatan Penduduk",
            "Kasus Diare (%)",
            "Kemiskinan (%)"
        ]

        for text in labels:
            self.layout.add_widget(Label(text=text))
            inp = TextInput(multiline=False, input_filter='float')
            self.layout.add_widget(inp)
            self.inputs.append(inp)

        btn = Button(text="Hitung EHRI", size_hint=(1, 0.2))
        btn.bind(on_press=self.calculate)
        self.layout.add_widget(btn)

        self.result = Label(text="Hasil: ")
        self.layout.add_widget(self.result)

        return self.layout

    def normalize(self, value, min_val=0, max_val=100):
        return ((value - min_val) / (max_val - min_val)) * 100

    def calculate(self, instance):
        try:
            values = [float(inp.text) for inp in self.inputs]

            # Normalisasi (asumsi 0â€“100)
            scores = [self.normalize(v) for v in values]

            # Bobot
            weights = [0.30, 0.25, 0.15, 0.20, 0.10]

            ehri = sum(s * w for s, w in zip(scores, weights))

            if ehri <= 33:
                category = "Risiko Rendah"
            elif ehri <= 66:
                category = "Risiko Sedang"
            else:
                category = "Risiko Tinggi"

            self.result.text = f"EHRI: {ehri:.2f} | {category}"

        except:
            self.result.text = "Input tidak valid"

if __name__ == "__main__":
    EHRIApp().run()
"""
          with open("main.py", "w") as f:
              f.write(main_code)

          # =========================
          # FILE 2: buildozer.spec
          # =========================
          spec_code = """
[app]
title = EHRI Calculator
package.name = ehricalculator
package.domain = org.ehri
source.dir = .
source.include_exts = py,png,jpg,kv,atlas
version = 1.0
requirements = python3,kivy
orientation = portrait
fullscreen = 0
android.archs = arm64-v8a
android.allow_backup = True
"""
          with open("buildozer.spec", "w") as f:
              f.write(spec_code)
          EOF

      - name: Build APK with Buildozer
        uses: ArtemSerebriakov/buildozer-action@v1
        with:
          command: buildozer android debug
          repository_root: .

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: EHRI-APK
          path: bin/*.apk
