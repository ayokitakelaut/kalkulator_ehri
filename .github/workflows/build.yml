name: Build EHRI APK CLEAN

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      # ðŸ’£ HANCURKAN SEMUA CACHE ANDROID & BUILDOZER
      - name: Destroy All Android & Buildozer Cache
        run: |
          rm -rf ~/.buildozer
          rm -rf ~/.gradle
          rm -rf ~/.android
          rm -rf ~/.cache
          rm -rf $HOME/android-sdk
          echo "All caches destroyed."

      - name: Install System Dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-pip git zip unzip openjdk-17-jdk wget
          pip install --upgrade pip
          pip install buildozer==1.5.0 cython

      - name: Create main.py
        run: |
          cat << 'EOF' > main.py
          from kivy.app import App
          from kivy.uix.boxlayout import BoxLayout
          from kivy.uix.textinput import TextInput
          from kivy.uix.button import Button
          from kivy.uix.label import Label

          class EHRIApp(App):
              def build(self):
                  layout = BoxLayout(orientation="vertical", padding=10, spacing=10)

                  labels = [
                      "Sanitasi (%)",
                      "Air Bersih (%)",
                      "Kepadatan Penduduk",
                      "Kasus Diare (%)",
                      "Kemiskinan (%)"
                  ]

                  self.inputs = []

                  for text in labels:
                      layout.add_widget(Label(text=text))
                      inp = TextInput(multiline=False, input_filter="float")
                      layout.add_widget(inp)
                      self.inputs.append(inp)

                  btn = Button(text="Hitung EHRI")
                  btn.bind(on_press=self.calculate)
                  layout.add_widget(btn)

                  self.result = Label(text="Hasil:")
                  layout.add_widget(self.result)

                  return layout

              def calculate(self, instance):
                  try:
                      values = [float(i.text) for i in self.inputs]
                      weights = [0.30, 0.25, 0.15, 0.20, 0.10]
                      ehri = sum(v*w for v,w in zip(values, weights))

                      if ehri <= 33:
                          kategori = "Risiko Rendah"
                      elif ehri <= 66:
                          kategori = "Risiko Sedang"
                      else:
                          kategori = "Risiko Tinggi"

                      self.result.text = f"EHRI: {ehri:.2f} | {kategori}"
                  except:
                      self.result.text = "Input tidak valid"

          if __name__ == "__main__":
              EHRIApp().run()
          EOF

      - name: Initialize Buildozer Spec (FORCED 33 ONLY)
        run: |
          buildozer init
          sed -i 's/title = .*/title = EHRI Calculator/' buildozer.spec
          sed -i 's/package.name = .*/package.name = ehricalculator/' buildozer.spec
          sed -i 's/package.domain = .*/package.domain = org.ehri/' buildozer.spec
          sed -i 's/requirements = .*/requirements = python3,kivy/' buildozer.spec
          sed -i 's/orientation = .*/orientation = portrait/' buildozer.spec

          echo "" >> buildozer.spec
          echo "android.api = 33" >> buildozer.spec
          echo "android.minapi = 21" >> buildozer.spec
          echo "android.sdk = 33" >> buildozer.spec
          echo "android.ndk = 25b" >> buildozer.spec
          echo "android.build_tools_version = 33.0.2" >> buildozer.spec
          echo "android.accept_sdk_license = True" >> buildozer.spec

      - name: Build APK
        run: |
          buildozer android debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: EHRI-APK
          path: bin/*.apk
